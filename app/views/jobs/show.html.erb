<h1>Job: <%= @job.title %> </h1>
<h2>Posted by <%= @job.user.first_name %></h2>

<% if @job.assigned_to.present? %> <!-- If job has been assigned -->
   <h2>Job has been assigned to: <%= @assigned_user.first_name  %></h2>
   
   <% if @current_user == @job.user %> <!-- Display contact details for job owner -->
    <h2>You can now contact <%= "#{ @assigned_user.first_name } #{ @assigned_user.last_name }" %> </h2>
    <h3> <%= "#{ @assigned_user.email } #{ @assigned_user.phone }" %> </h3>
   <% end %>

    <% if @current_user.id == @job.assigned_to %> <!-- Display contact details for job assignee -->
    <h2>You have been assigned this job! You can now contact <%= "#{ @job.user.first_name } #{ @job.user.last_name }" %> </h2>
    <h3> <%= "#{ @job.user.email } #{ @job.user.phone }" %> </h3>
   <% end %>
<% end%>

<ul>
    <li><%= @job.desc %></li>
    <li>Price: <%= number_to_currency @job.price, precision: 0 %></li>
    
    <li>Address: 
     <% if @job.assigned_to.present? && @current_user == @job.user %> <!-- Display house number only when job has been assigned and to job owner -->
        <%= @job.user.address_num %>
    <% end %>
    
    <%= @job.user.address_street %></li>
    <li>City: <%= @job.user.address_city %></li>
    <li><ul> Categories:
    <% @job.categories.each do |category| %>
        <li><%= category.name %></li>
    <% end  %>
    </ul></li>

    <% @job.images.each do |i| %>
         <%= cl_image_tag(i, :width => 300) %>
    <% end %>

    <li>Posted: <%= time_ago_in_words(@job.created_at) %> ago</li>
    <li>Last Updated: <%= time_ago_in_words(@job.updated_at) %> ago</li>

</ul>



<strong>Comments:</strong>
  
    <% if @job.comments.length == 0 %>
        <p>No comments yet</p>
    <% end  %>

 <% if @job.assigned_to == nil %>
    <%= link_to "Add Comment", new_comment_path %>
 <% end%>

<ul>
     <% @job.comments.order(:updated_at).reverse_order.each do |comment| %>
        <li><%= time_ago_in_words(comment.updated_at) %> ago<br>
        "<%= comment.comment %>" by:  
        <%= comment.user.first_name %>
        <!-- Comment owner only -->
        <% if comment.user_id == @current_user.id && @job.assigned_to == nil %>
            <div><%= link_to "Edit comment", edit_comment_path(comment) %>
            <%= link_to "Delete comment", comment_path(comment), :method => 'delete', :data => { :confirm => 'Are you sure?' } %></div>
        <% end  %>
        <!-- Assign job button - Job owner only and if job is unassigned -->
        <% if @job.user_id == @current_user.id && @job.assigned_to == nil && comment.user_id != @current_user.id %>
        <%= form_tag assign_job_path do %>
            <%= hidden_field_tag :job_id,  @job.id %>
            <%= hidden_field_tag :assignee_user_id, comment.user.id %>
            <%= submit_tag "Assign Job to #{ comment.user.first_name }", :data => { :confirm => "Assign Job to #{ comment.user.first_name }?"} %>
            <% end  %>
        <% end  %>

    <% end %>
</ul>

<!-- Job owner only -->
<% if @job.user_id == @current_user.id %>  
     <% if @job.assigned_to == nil %>
        <%= link_to "Edit Job", edit_job_path(@job.id) %>
    <% end%>
    
    <%= link_to "Delete Job", job_path(@job.id), :method => 'delete', :data => { :confirm => 'Are you sure?' } %>
<% end  %>





